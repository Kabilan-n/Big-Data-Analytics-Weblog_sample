//19AIE214 Big Data Analytics
//Assignments

//Date: May 3 2021

//Kabilan N
//CB.EN.U4AIE19033


// 3. Use file ‘weblogsample.csv’ and perform the following analytics


val weblogsampleRdd=sc.textFile("Data\\weblogsample.csv")
// weblogsampleRdd: org.apache.spark.rdd.RDD[String] = Data\weblogsample.csv MapPartitionsRDD[1] at textFile at <console>:24

val weblogReducedRdd=weblogsampleRdd.map{l =>
	val s = l.split(',')
    val (ip, date, time, zone, cik, accession, extention, code, size, idx, norefer, noagent, find, crawler)=(s(0), s(1),  s(2),  s(3),  s(4),  s(5),  s(6),  s(7),  s(8),  s(9),  s(10),  s(11),  s(12),  s(13))
    (ip, date, time, zone, cik, accession, extention, code, size, idx, norefer, noagent, find, crawler)}
// weblogReducedRdd: org.apache.spark.rdd.RDD[(String, String, String, String, String, String, String, String, String, String, String, String, String, String)] = MapPartitionsRDD[2] at map at <console>:26

val headerRdd = weblogReducedRdd.first()
// headerRdd: (String, String, String, String, String, String, String, String, String, String, String, String, String, String) = (ip,date,time,zone,cik,accession,extention,code,size,idx,norefer,noagent,find,crawler)


val weblogsampleReducedRdd= weblogReducedRdd.filter(row => row != headerRdd )
// weblogsampleReducedRdd: org.apache.spark.rdd.RDD[(String, String, String, String, String, String, String, String, String, String, String, String, String, String)] = MapPartitionsRDD[3] at filter at <console>:30

// a) Create key value pair from the raw CSV data
val KVPairRdd= weblogsampleReducedRdd.map{ case(ip, date, time, zone, cik, accession, extention, code, size, idx, norefer, noagent, find, crawler)=>
    ( accession,List(ip, date, time, zone, cik, extention , code, size, idx, norefer, noagent, find, crawler)) }
// KVPairRdd: org.apache.spark.rdd.RDD[(String, List[String])] = MapPartitionsRDD[4] at map at <console>:32

KVPairRdd.toDF("Key "," Value").show()
/*+--------------------+--------------------+
|                Key |               Value|
+--------------------+--------------------+
|0001209191-16-111028|[101.81.76.dii, 2...|
|0001407682-16-000270|[104.40.128.jig, ...|
|0001183887-16-000354|[104.40.128.jig, ...|
|0001407682-16-000270|[104.40.128.jig, ...|
|0001183887-16-000354|[104.40.128.jig, ...|
|0001407682-16-000270|[104.40.128.jig, ...|
|0001407682-16-000270|[104.40.128.jig, ...|
|0001183887-16-000354|[104.40.128.jig, ...|
|0001183887-16-000354|[104.40.128.jig, ...|
|0001594062-16-000417|[107.178.195.cej,...|
|0001019687-16-005675|[107.178.195.cej,...|
|0000721748-16-001126|[107.178.195.fgg,...|
|0001144204-16-091485|[121.200.54.aah, ...|
|0001144204-15-066965|[123.125.64.abf, ...|
|0001127602-09-003221|[128.118.209.fbd,...|
|0001127602-09-003229|[128.118.209.fbd,...|
|0001127602-09-003231|[128.118.209.fbd,...|
|0001127602-09-003224|[128.118.209.fbd,...|
|0001127602-09-003230|[128.118.209.fbd,...|
|0001127602-09-003228|[128.118.209.fbd,...|
+--------------------+--------------------+
only showing top 20 rows*/


// b) Sort the data based on time stamp (3rd field).

val TimeReducedRdd=weblogsampleReducedRdd.sortBy(_._3)
// TimeReducedRdd: org.apache.spark.rdd.RDD[(String, String, String, String, String, String, String, String, String, String, String, String, String, String)] = MapPartitionsRDD[17] at sortBy at <console>:32

TimeReducedRdd.toDF("ip", "date", "time", "zone", "cik", "accession", "extention", "code", "size", "idx", "norefer", "noagent", "find", "crawler").show(20)
/*21/05/03 21:44:42 WARN Executor: Managed memory leak detected; size = 38096892 bytes, TID = 8
+---------------+----------+--------+----+---------+--------------------+---------------+-----+--------+---+-------+-------+----+-------+
|             ip|      date|    time|zone|      cik|           accession|      extention| code|    size|idx|norefer|noagent|find|crawler|
+---------------+----------+--------+----+---------+--------------------+---------------+-----+--------+---+-------+-------+----+-------+
|  101.81.76.dii|2016-03-31|00:00:00| 0.0|1283497.0|0001209191-16-111028|     -index.htm|200.0| 14926.0|1.0|    0.0|    0.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1094392.0|0001407682-16-000270|           .txt|200.0|  5161.0|0.0|    0.0|    0.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0| 278130.0|0001183887-16-000354|           .txt|200.0|  5105.0|0.0|    0.0|    0.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1389680.0|0001407682-16-000270|           .txt|301.0|   237.0|0.0|    0.0|    1.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1439019.0|0001183887-16-000354|           .txt|301.0|   237.0|0.0|    0.0|    1.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1094392.0|0001407682-16-000270|           .txt|301.0|   237.0|0.0|    0.0|    1.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1389680.0|0001407682-16-000270|           .txt|200.0|  5161.0|0.0|    0.0|    0.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1439019.0|0001183887-16-000354|           .txt|200.0|  5105.0|0.0|    0.0|    0.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0| 278130.0|0001183887-16-000354|           .txt|301.0|   236.0|0.0|    0.0|    1.0|10.0|    0.0|
|107.178.195.cej|2016-03-31|00:00:00| 0.0|1402737.0|0001594062-16-000417|      -xbrl.zip|200.0|155422.0|0.0|    0.0|    0.0|10.0|    0.0|
|107.178.195.cej|2016-03-31|00:00:00| 0.0|1063104.0|0001019687-16-005675|      -xbrl.zip|200.0| 51009.0|0.0|    0.0|    0.0|10.0|    0.0|
|107.178.195.fgg|2016-03-31|00:00:00| 0.0|1174672.0|0000721748-16-001126|      -xbrl.zip|200.0| 75571.0|0.0|    0.0|    0.0|10.0|    0.0|
| 121.200.54.aah|2016-03-31|00:00:00| 0.0|1372514.0|0001144204-16-091485|v434534_10k.htm|200.0|137569.0|0.0|    0.0|    0.0|10.0|    0.0|
| 123.125.64.abf|2016-03-31|00:00:00| 0.0| 728387.0|0001144204-15-066965|     -index.htm|200.0|  5497.0|1.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0| 706688.0|0001127602-09-003221|           .txt|200.0|  2262.0|0.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0| 822416.0|0001127602-09-003229|           .txt|200.0|  2393.0|0.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0| 822416.0|0001127602-09-003231|           .txt|200.0|  2127.0|0.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0|1168054.0|0001127602-09-003224|           .txt|200.0|  2613.0|0.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0| 822416.0|0001127602-09-003230|           .txt|200.0|  2328.0|0.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0|1020062.0|0001127602-09-003228|           .txt|200.0|  3892.0|0.0|    0.0|    0.0|10.0|    0.0|
+---------------+----------+--------+----+---------+--------------------+---------------+-----+--------+---+-------+-------+----+-------+
only showing top 20 rows*/


// c) Find out all unique file types accessed.

val UniqueTypes= weblogsampleReducedRdd.map(c =>
    if(c._7.contains('.')) (c._7.split('.')(1),1)
    else (c._7,1))
// UniqueTypes: org.apache.spark.rdd.RDD[(String, Int)] = MapPartitionsRDD[21] at map at <console>:32

val UniqueTypesReduced = UniqueTypes.reduceByKey(_+_)
// UniqueTypesReduced: org.apache.spark.rdd.RDD[(String, Int)] = ShuffledRDD[22] at reduceByKey at <console>:34

UniqueTypesReduced.count()
// res4: Long = 22

UniqueTypesReduced.toDF("File types","Number of times").show(22)
/*+--------------------+---------------+
|          File types|Number of times|
+--------------------+---------------+
|                 hdr|            135|
|               paper|             13|
|                   4|              1|
|                   x|              1|
|pfe-%20%20%20%20%...|              1|
|                 pdf|             57|
|xslForm13F_X01/Gr...|              1|
|                 txt|          12591|
|                 fil|              9|
|                  js|              3|
|                 xml|           5673|
|       htm?URL=http%|             26|
|                 css|              3|
|                  xm|              4|
|htm?utm_campaign=...|              1|
|                 xls|              5|
|                 htm|          30328|
|                xlsx|            207|
|                   1|              1|
|                html|            407|
|                 zip|            477|
|                 xsd|             55|
+--------------------+---------------+
*/


// d) Find how many time ‘.xml’ type was denied (8th field should be 404.0)

val xmlDeniedRdd =weblogsampleReducedRdd.filter(l => (l._7.contains(".xml")) &&  (l._8 == "404.0"))
// xmlDeniedRdd: org.apache.spark.rdd.RDD[(String, String, String, String, String, String, String, String, String, String, String, String, String, String)] = MapPartitionsRDD[32] at filter at <console>:32


// e) Find the count of total denials.

xmlDeniedRdd.count()
// res6: Long = 273

xmlDeniedRdd.toDF.show(20)
/*+---------------+----------+--------+---+---------+--------------------+---------------+-----+-------+---+---+---+----+---+
|             _1|        _2|      _3| _4|       _5|                  _6|             _7|   _8|     _9|_10|_11|_12| _13|_14|
+---------------+----------+--------+---+---------+--------------------+---------------+-----+-------+---+---+---+----+---+
|192.241.253.fdh|2016-03-31|00:00:07|0.0|1271502.0|0001209191-13-034300|       doc4.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:07|0.0|1375796.0|0001209191-13-033837|       doc3.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:07|0.0|   9263.0|0001209191-13-035614|c564420_4x0.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:07|0.0|1509589.0|0001179110-13-011482|      edgar.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:08|0.0|1016169.0|0001181431-13-038791|  rrd384974.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:08|0.0| 895126.0|0000895126-13-000228|   edgardoc.xml|404.0|39885.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:08|0.0| 895126.0|0000895126-13-000227|   edgardoc.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:08|0.0| 814585.0|0001140361-13-027417|       doc1.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:08|0.0| 773910.0|0001127602-13-022375|      form4.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:08|0.0|1366042.0|0001140361-13-027401|       doc1.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:08|0.0|1016169.0|0001181431-13-038746|  rrd384974.xml|404.0|39885.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:08|0.0|1242818.0|0001181431-13-038758|  rrd385247.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:08|0.0|1509589.0|0001179110-13-011475|      edgar.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:08|0.0|1016169.0|0001181431-13-038737|  rrd384976.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:09|0.0| 909954.0|0001179110-13-011463|      edgar.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:09|0.0|1509589.0|0001179110-13-011459|      edgar.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:09|0.0| 909954.0|0001179110-13-011471|      edgar.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:09|0.0|1242818.0|0001181431-13-038740|  rrd385247.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:09|0.0| 909954.0|0001179110-13-011476|      edgar.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
|192.241.253.fdh|2016-03-31|00:00:09|0.0|1366042.0|0001140361-13-027408|       doc1.xml|404.0|39873.0|0.0|0.0|0.0|10.0|1.0|
+---------------+----------+--------+---+---------+--------------------+---------------+-----+-------+---+---+---+----+---+
only showing top 20 rows
*/


// f) Sort based on file types.

val SortTypesRdd= weblogsampleReducedRdd.map(c =>
    if(c._7.contains('.')) (c._7.split('.')(1),List(c._6))
    else (c._7,List(c._6))).reduceByKey(_++_).map{case(x,y) =>(x,y.length) }.sortByKey()
// SortTypesRdd: org.apache.spark.rdd.RDD[(String, Int)] = ShuffledRDD[44] at sortByKey at <console>:34

SortTypesRdd.toDF("File type","Number of acession number").show(20)
/*+--------------------+-------------------------+
|           File type|Number of acession number|
+--------------------+-------------------------+
|                   1|                        1|
|                   4|                        1|
|                 css|                        3|
|                 fil|                        9|
|                 hdr|                      135|
|                 htm|                    30328|
|       htm?URL=http%|                       26|
|htm?utm_campaign=...|                        1|
|                html|                      407|
|                  js|                        3|
|               paper|                       13|
|                 pdf|                       57|
|pfe-%20%20%20%20%...|                        1|
|                 txt|                    12591|
|                   x|                        1|
|                 xls|                        5|
|                xlsx|                      207|
|                  xm|                        4|
|                 xml|                     5673|
|                 xsd|                       55|
+--------------------+-------------------------+
only showing top 20 rows*/

// g) Create a Data Frame(DF) of the full data and show it in tabular form with column names

weblogsampleReducedRdd.toDF("ip", "date", "time", "zone", "cik", "accession", "extention", "code", "size", "idx", "norefer", "noagent", "find", "crawler").show(20)
/*+---------------+----------+--------+----+---------+--------------------+---------------+-----+--------+---+-------+-------+----+-------+
|             ip|      date|    time|zone|      cik|           accession|      extention| code|    size|idx|norefer|noagent|find|crawler|
+---------------+----------+--------+----+---------+--------------------+---------------+-----+--------+---+-------+-------+----+-------+
|  101.81.76.dii|2016-03-31|00:00:00| 0.0|1283497.0|0001209191-16-111028|     -index.htm|200.0| 14926.0|1.0|    0.0|    0.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1094392.0|0001407682-16-000270|           .txt|200.0|  5161.0|0.0|    0.0|    0.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0| 278130.0|0001183887-16-000354|           .txt|200.0|  5105.0|0.0|    0.0|    0.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1389680.0|0001407682-16-000270|           .txt|301.0|   237.0|0.0|    0.0|    1.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1439019.0|0001183887-16-000354|           .txt|301.0|   237.0|0.0|    0.0|    1.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1094392.0|0001407682-16-000270|           .txt|301.0|   237.0|0.0|    0.0|    1.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1389680.0|0001407682-16-000270|           .txt|200.0|  5161.0|0.0|    0.0|    0.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0|1439019.0|0001183887-16-000354|           .txt|200.0|  5105.0|0.0|    0.0|    0.0|10.0|    0.0|
| 104.40.128.jig|2016-03-31|00:00:00| 0.0| 278130.0|0001183887-16-000354|           .txt|301.0|   236.0|0.0|    0.0|    1.0|10.0|    0.0|
|107.178.195.cej|2016-03-31|00:00:00| 0.0|1402737.0|0001594062-16-000417|      -xbrl.zip|200.0|155422.0|0.0|    0.0|    0.0|10.0|    0.0|
|107.178.195.cej|2016-03-31|00:00:00| 0.0|1063104.0|0001019687-16-005675|      -xbrl.zip|200.0| 51009.0|0.0|    0.0|    0.0|10.0|    0.0|
|107.178.195.fgg|2016-03-31|00:00:00| 0.0|1174672.0|0000721748-16-001126|      -xbrl.zip|200.0| 75571.0|0.0|    0.0|    0.0|10.0|    0.0|
| 121.200.54.aah|2016-03-31|00:00:00| 0.0|1372514.0|0001144204-16-091485|v434534_10k.htm|200.0|137569.0|0.0|    0.0|    0.0|10.0|    0.0|
| 123.125.64.abf|2016-03-31|00:00:00| 0.0| 728387.0|0001144204-15-066965|     -index.htm|200.0|  5497.0|1.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0| 706688.0|0001127602-09-003221|           .txt|200.0|  2262.0|0.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0| 822416.0|0001127602-09-003229|           .txt|200.0|  2393.0|0.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0| 822416.0|0001127602-09-003231|           .txt|200.0|  2127.0|0.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0|1168054.0|0001127602-09-003224|           .txt|200.0|  2613.0|0.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0| 822416.0|0001127602-09-003230|           .txt|200.0|  2328.0|0.0|    0.0|    0.0|10.0|    0.0|
|128.118.209.fbd|2016-03-31|00:00:00| 0.0|1020062.0|0001127602-09-003228|           .txt|200.0|  3892.0|0.0|    0.0|    0.0|10.0|    0.0|
+---------------+----------+--------+----+---------+--------------------+---------------+-----+--------+---+-------+-------+----+-------+
only showing top 20 rows*/